###### Setup Pi #####
# Login information
useKerberos <- TRUE
username <- "knewhart"
password <- "Lunabear2@"
validateSSL <- TRUE
debug <- TRUE
piWebApiService <- piwebapi$new("https://pivision/piwebapi", useKerberos, username, password, validateSSL, debug)
# Load tags
pi.tags <- read_excel("C:/Users/KNewhart/Documents/GitHub/MWRD/pi-tags.xls")
pi.tags <- na.omit(pi.tags)
# Fix tags
for(i in 1:nrow(pi.tags)) {
if(is.na(pi.tags[i,2])) next
if(substr(pi.tags[i,2],1,12) == "\\\\APPLEPI_AF") pi.tags[i,2] <- paste0("af:", pi.tags[i,2])
if(substr(pi.tags[i,2],1,9) == "\\\\applepi") pi.tags[i,2] <- paste0("pi:", pi.tags[i,2])
if(substr(pi.tags[i,2],1,9) == "\\\\APPLEPI") pi.tags[i,2] <- paste0("pi:", pi.tags[i,2])
}
# Select variables
var <- c("North Pre-PAA E. coli")
# Set time
start <- paste0("2019-01-01", "T06:00:00Z") # Make sure to convert time to GMT
end <- paste0(as.character(as.Date(Sys.time()) - 1), "T00:00:00Z")
var.n <- sapply(var, function(x) which(x == pi.tags[,1]))
# Fix timestamps - this function creates an xts object from the piWebApiService function above
fix.timestamps <- function(pi.data) {
ch.times <- pi.data[,2]
ch.times <- sub("T", " ", ch.times)
ch.times <- sub("Z", " ", ch.times)
return(cbind(ch.times, pi.data[,1]))
}
# Load daily data
if (exists("all.data")) rm(all.data)
for(i in var.n) {
# assign(make.names(pi.tags[i,1]), piWebApiService$data$getInterpolatedValues(path=unlist(pi.tags[i,2]), startTime = start, endTime = end, interval = "1d")[,1:2])
# assign(make.names(pi.tags[i,1]), fix.timestamps(get(make.names(pi.tags[i,1]))))
# new.objects <- c(new.objects, list(make.names(pi.tags[i,1])))
data.holder <- piWebApiService$data$getRecordedValues(path=as.character(pi.tags[i,2]), startTime = start, endTime = end)[,1:2]
# data.holder <- piWebApiService$data$getInterpolatedValues(path=unlist(pi.tags[i,2]), startTime = start, endTime = end, interval = "1d")[,1:2]
data.holder <- fix.timestamps(data.holder)
data.holder <- xts(as.numeric(data.holder[,2]), order.by = as.POSIXct(data.holder[,1], format = "%Y-%m-%d %H:%M:%S", TZ="GMT"))
colnames(data.holder) <- make.names(pi.tags[i,1])
if (!exists("all.data")) {
all.data <- data.holder
} else {
all.data <- merge(all.data, data.holder)
}
}
ecoli <- all.data
timestamps <- index(all.data)
new.timestamps <- stringr::str_c(stringr::str_sub(as.character(timestamps),1,10), "T")
new.timestamps <- stringr::str_c(new.timestamps, stringr::str_sub(as.character(timestamps),12,19),"Z")
var <- c(
"North Clarifier 1 Sludge Blanket", # Clarifiers selected from timeseries plots
"North Clarifier 6 Sludge Blanket", # See pre-dis-ecoli-sludge-blanket.png
"North Clarifier 11 Sludge Blanket",
"North Clarifier 12 Sludge Blanket",
"North AB5 RAS TSS",
"North AB4 TSS",
"North AB10 RAS TSS",
"North AB9 RAS TSS",
"North Secondary Aerobic SRT",
"North Secondary Effluent NH3",
"North Secondary Effluent NO3",
"North Secondary Effluent OP",
"North Secondary Effluent TSS",
"North Secondary Effluent NO5",
"North Secondary Influent COD",
"North Secondary Influent Flow",
"North Secondary Influent NH3",
"North Secondary Influent NH3-N",
"North Secondary Influent NO3",
"North Secondary Influent Temperature",
# "North Secondary Influent TKN",
"North Secondary Influent TSS",
"North Secondary Total RAS Flow (MGD)"
# "North Disinfection Flow"
)
var.n <- sapply(var, function(x) which(x == pi.tags[,1]))
getPiData <- function(path,
t,  # as POSIXct
i = 15, # interval in min
n = 1 # periods forward and back to collect data
) {
new.t <- stringr::str_c(stringr::str_sub(as.character(t),1,10), "T")
new.t <- stringr::str_c(new.timestamps, stringr::str_sub(as.character(t),12,19),"Z")
start.t <- t - n*i*60
start.t <- stringr::str_c(stringr::str_sub(as.character(start.t),1,10), "T", stringr::str_sub(as.character(start.t),12,19),"Z")
end.t <- t + n*i*60
end.t <- stringr::str_c(stringr::str_sub(as.character(end.t),1,10), "T", stringr::str_sub(as.character(end.t),12,19),"Z")
holder <- piwebapi::piWebApiService$data$getInterpolatedValues(path=path, startTime = start.t, endTime = end.t, interval = paste0(i,"m"))[,1:2]
return(holder)
}
v.data <- data.frame()
for(v in var.n[1:2]) {
t.data <- data.frame()
p <- as.character(unlist(pi.tags[v,2]))
for(t in 1:length(timestamps)) {
data <- getPiData(path=p, t=timestamps[t], i=15, n=1)
row <- data[round(nrow(data)/2),2]
data <- data.frame(data[round(nrow(data)/2),1])
rownames(data) <- row
t.data <- rbind(t.data, data)
}
if(nrow(v.data) != 0) v.data <- cbind(v.data, t.data)
if(nrow(v.data) == 0) v.data <- t.data
colnames(v.data)[ncol(v.data)] <- as.character(unlist(pi.tags[v,1]))
}
getPiData <- function(path,
t,  # as POSIXct
i = 15, # interval in min
n = 1 # periods forward and back to collect data
) {
new.t <- stringr::str_c(stringr::str_sub(as.character(t),1,10), "T")
new.t <- stringr::str_c(new.timestamps, stringr::str_sub(as.character(t),12,19),"Z")
start.t <- t - n*i*60
start.t <- stringr::str_c(stringr::str_sub(as.character(start.t),1,10), "T", stringr::str_sub(as.character(start.t),12,19),"Z")
end.t <- t + n*i*60
end.t <- stringr::str_c(stringr::str_sub(as.character(end.t),1,10), "T", stringr::str_sub(as.character(end.t),12,19),"Z")
holder <- piWebApiService$data$getInterpolatedValues(path=path, startTime = start.t, endTime = end.t, interval = paste0(i,"m"))[,1:2]
return(holder)
}
v.data <- data.frame()
for(v in var.n[1:2]) {
t.data <- data.frame()
p <- as.character(unlist(pi.tags[v,2]))
for(t in 1:length(timestamps)) {
data <- getPiData(path=p, t=timestamps[t], i=15, n=1)
row <- data[round(nrow(data)/2),2]
data <- data.frame(data[round(nrow(data)/2),1])
rownames(data) <- row
t.data <- rbind(t.data, data)
}
if(nrow(v.data) != 0) v.data <- cbind(v.data, t.data)
if(nrow(v.data) == 0) v.data <- t.data
colnames(v.data)[ncol(v.data)] <- as.character(unlist(pi.tags[v,1]))
}
View(v.data)
v.data <- data.frame()
for(v in var.n[1:2]) {
t.data <- data.frame()
p <- as.character(unlist(pi.tags[v,2]))
for(t in 1:length(timestamps)) {
data <- getPiData(path=p, t=timestamps[t], i=15, n=1)
row <- data[round(nrow(data)/2),2]
data <- data.frame(data[round(nrow(data)/2),1])
rownames(data) <- row
t.data <- rbind(t.data, data)
}
if(nrow(v.data) != 0) v.data <- cbind(v.data, t.data)
if(nrow(v.data) == 0) v.data <- t.data
colnames(v.data)[ncol(v.data)] <- as.character(unlist(pi.tags[v,1]))
print(paste(Sys.time(), "finished", colnames(v.data)[ncol(v.data)]))
}
View(v.data)
data <- invisible(getPiData(path=p, t=timestamps[t], i=15, n=1))
data <- capture.output(getPiData(path=p, t=timestamps[t], i=15, n=1), file=NULL)
v.data <- data.frame()
for(v in var.n) {
t.data <- data.frame()
p <- as.character(unlist(pi.tags[v,2]))
for(t in 1:length(timestamps)) {
data <- getPiData(path=p, t=timestamps[t], i=15, n=1)
row <- data[round(nrow(data)/2),2]
data <- data.frame(data[round(nrow(data)/2),1])
rownames(data) <- row
t.data <- rbind(t.data, data)
}
if(nrow(v.data) != 0) v.data <- cbind(v.data, t.data)
if(nrow(v.data) == 0) v.data <- t.data
colnames(v.data)[ncol(v.data)] <- as.character(unlist(pi.tags[v,1]))
print(paste(Sys.time(), "finished", colnames(v.data)[ncol(v.data)]))
}
View(v.data)
View(ecoli)
all.data <- fix.timestamps(cbind(v.data[1,], rownames(v.data)))
all.data <- fix.timestamps(cbind(v.data[1,], row.names(v.data)))
row.names(v.data)
View(all.data)
ch.times <- row.names(v.data)
ch.times <- sub("T", " ", ch.times)
ch.times <- sub("Z", " ", ch.times)
View(ch.times)
all.data <- xts(v.data, order.by = as.POSIXct(ch.times, "%Y-%m-%d %H:%M:%S"))
View(all.data)
all.data <- cbind(all.data, ecoli)
View(all.data)
all.data <- xts(v.data, order.by = as.POSIXct(ch.times, "%Y-%m-%d %H:%M:%S", tz="GMT"))
all.data <- cbind(all.data, ecoli)
all.data <- xts(v.data, order.by = as.POSIXct(ch.times, "%Y-%m-%d %H:%M:%S", tz="MDT"))
all.data <- cbind(all.data, ecoli)
all.data <- xts(v.data, order.by = as.POSIXct(ch.times, "%Y-%m-%d %H:%M:%S")-6*60*60)
all.data <- cbind(all.data, ecoli)
all.data <- xts(v.data, order.by = as.POSIXct(ch.times, "%Y-%m-%d %H:%M:%S", "GMT"))
View(all.data)
all.data <- xts(v.data, order.by = as.POSIXct(ch.times, "%Y-%m-%d %H:%M:%S", "GMT"))
View(all.data)
rm(all.data)
all.data <- xts(v.data, order.by = as.POSIXct(ch.times, "%Y-%m-%d %H:%M:%S", "GMT"))
View(ch.times)
View(v.data)
as.POSIXct(ch.times, "%Y-%m-%d %H:%M:%S", "GMT")
as.POSIXct(ch.times, "%Y-%m-%d %H:%M:%S", tz="GMT")
all.data <- xts(v.data, order.by = as.POSIXct(ch.times, "%Y-%m-%d %H:%M:%S", tz="GMT"))
str(index(ecoli))
str(index(all.data))
?as.POSIXct
attr(index(ecoli), "tzone")
attr(index(all.data), "tzone")
all.data <- xts(v.data, order.by = as.POSIXct(ch.times, "%Y-%m-%d %H:%M:%S", tz=""))
all.data <- cbind(all.data, ecoli)
View(all.data)
cols2remove <- sapply(cols2remove, function(x) which(x == colnames(all.data)))
cols2remove <- c("North.Secondary.Influent.COD, North.Secondary.Influent.NO3, North.Secondary.Influent.TSS")
rows2remove <- c("North.Secondary.Influent.NH3")
cols2remove <- sapply(cols2remove, function(x) which(x == colnames(all.data)))
rows2remove <- sapply(rows2remove, function(x) which(x == colnames(all.data)))
all.data <- all.data[which(!is.na(all.data[,rows2remove])), -cols2remove]
all.data <- xts(v.data, order.by = as.POSIXct(ch.times, "%Y-%m-%d %H:%M:%S", tz=""))
all.data <- cbind(all.data, ecoli)
cols2remove <- c("North.Secondary.Influent.COD, North.Secondary.Influent.NO3, North.Secondary.Influent.TSS")
rows2remove <- c("North.Secondary.Influent.NH3")
cols2remove <- sapply(cols2remove, function(x) which(x == colnames(all.data)))
rows2remove <- sapply(rows2remove, function(x) which(x == colnames(all.data)))
all.data <- all.data[which(!is.na(all.data[,rows2remove])), -cols2remove]
rows2remove <- sapply(rows2remove, function(x) which(x == colnames(all.data)))
cols2remove <- c("North.Secondary.Influent.COD", "North.Secondary.Influent.NO3", "North.Secondary.Influent.TSS")
rows2remove <- c("North.Secondary.Influent.NH3")
cols2remove <- sapply(cols2remove, function(x) which(x == colnames(all.data)))
rows2remove <- sapply(rows2remove, function(x) which(x == colnames(all.data)))
all.data <- all.data[which(!is.na(all.data[,rows2remove])), -cols2remove]
source('~/GitHub/MWRD/Neural Networks/pre-dis-ecoli.R', echo=TRUE)
rm(list=ls())
library(xts)
library(readxl)
# devtools::install_github("rbechalany/PI-Web-API-Client-R")
library(piwebapi)
###### Setup Pi #####
# Login information
useKerberos <- TRUE
username <- "knewhart"
password <- "Lunabear2@"
validateSSL <- TRUE
debug <- TRUE
piWebApiService <- piwebapi$new("https://pivision/piwebapi", useKerberos, username, password, validateSSL, debug)
# Load tags
pi.tags <- read_excel("C:/Users/KNewhart/Documents/GitHub/MWRD/pi-tags.xls")
pi.tags <- na.omit(pi.tags)
# Fix tags
for(i in 1:nrow(pi.tags)) {
if(is.na(pi.tags[i,2])) next
if(substr(pi.tags[i,2],1,12) == "\\\\APPLEPI_AF") pi.tags[i,2] <- paste0("af:", pi.tags[i,2])
if(substr(pi.tags[i,2],1,9) == "\\\\applepi") pi.tags[i,2] <- paste0("pi:", pi.tags[i,2])
if(substr(pi.tags[i,2],1,9) == "\\\\APPLEPI") pi.tags[i,2] <- paste0("pi:", pi.tags[i,2])
}
# Select variables
var <- c("North Pre-PAA E. coli")
# Set time
start <- paste0("2019-01-01", "T06:00:00Z") # Make sure to convert time to GMT
end <- paste0(as.character(as.Date(Sys.time()) - 1), "T00:00:00Z")
var.n <- sapply(var, function(x) which(x == pi.tags[,1]))
# Fix timestamps - this function creates an xts object from the piWebApiService function above
fix.timestamps <- function(pi.data) {
ch.times <- pi.data[,2]
ch.times <- sub("T", " ", ch.times)
ch.times <- sub("Z", " ", ch.times)
return(cbind(ch.times, pi.data[,1]))
}
# Load daily data
if (exists("all.data")) rm(all.data)
for(i in var.n) {
# assign(make.names(pi.tags[i,1]), piWebApiService$data$getInterpolatedValues(path=unlist(pi.tags[i,2]), startTime = start, endTime = end, interval = "1d")[,1:2])
# assign(make.names(pi.tags[i,1]), fix.timestamps(get(make.names(pi.tags[i,1]))))
# new.objects <- c(new.objects, list(make.names(pi.tags[i,1])))
data.holder <- piWebApiService$data$getRecordedValues(path=as.character(pi.tags[i,2]), startTime = start, endTime = end)[,1:2]
# data.holder <- piWebApiService$data$getInterpolatedValues(path=unlist(pi.tags[i,2]), startTime = start, endTime = end, interval = "1d")[,1:2]
data.holder <- fix.timestamps(data.holder)
data.holder <- xts(as.numeric(data.holder[,2]), order.by = as.POSIXct(data.holder[,1], format = "%Y-%m-%d %H:%M:%S", TZ="GMT"))
colnames(data.holder) <- make.names(pi.tags[i,1])
if (!exists("all.data")) {
all.data <- data.holder
} else {
all.data <- merge(all.data, data.holder)
}
}
ecoli <- all.data
timestamps <- index(all.data)
new.timestamps <- stringr::str_c(stringr::str_sub(as.character(timestamps),1,10), "T")
new.timestamps <- stringr::str_c(new.timestamps, stringr::str_sub(as.character(timestamps),12,19),"Z")
#
# start.and.end <- matrix(nrow=nrow(ecoli)-1,ncol=2)
# library(stringr)
# for(row in 2:nrow(ecoli)){
#   start <- index(ecoli)[row-1]
#   end <- index(ecoli)[row]
#   start.and.end[row-1,1] <- str_c(str_sub(as.character(start),1,10), "T",str_sub(as.character(start),12,19),"Z")
#   start.and.end[row-1,2] <- str_c(str_sub(as.character(end),1,10), "T",str_sub(as.character(end),12,19),"Z")
# }
var <- c(
"North Clarifier 1 Sludge Blanket", # Clarifiers selected from timeseries plots
"North Clarifier 6 Sludge Blanket", # See pre-dis-ecoli-sludge-blanket.png
"North Clarifier 11 Sludge Blanket",
"North Clarifier 12 Sludge Blanket",
"North AB5 RAS TSS",
"North AB4 TSS",
"North AB10 RAS TSS",
"North AB9 RAS TSS",
"North Secondary Aerobic SRT",
"North Secondary Effluent NH3",
"North Secondary Effluent NO3",
"North Secondary Effluent OP",
"North Secondary Effluent TSS",
"North Secondary Effluent NO5",
"North Secondary Influent COD",
"North Secondary Influent Flow",
"North Secondary Influent NH3",
"North Secondary Influent NH3-N",
"North Secondary Influent NO3",
"North Secondary Influent Temperature",
# "North Secondary Influent TKN",
"North Secondary Influent TSS",
"North Secondary Total RAS Flow (MGD)"
# "North Disinfection Flow"
)
var.n <- sapply(var, function(x) which(x == pi.tags[,1]))
#
# # Load daily data
# if (exists("all.data")) rm(all.data)
# for(t in new.timestamps) {
#   data.holder <- piWebApiService$data$getMultipleRecordedValues(paths=c(unlist(pi.tags[var.n,2])), startTime = t)
#   data.holder <- lapply(data.holder, function(x) fix.timestamps(x[1,1:2]))
#   data.holder <- lapply(data.holder, function(x) xts(as.numeric(x[,2]), order.by = as.POSIXct(x[,1], format = "%Y-%m-%d %H:%M:%S", TZ="MST")-6*60*60))
#   data.holder <- do.call(merge, data.holder)
#   colnames(data.holder) <- var
#   if (!exists("all.data")) {
#     all.data <- data.holder
#   } else {
#     all.data <- rbind(all.data, data.holder)
#   }
# }
# save(file = "pre-dis-ecoli-all-data.RData","all.data")
# load("pre-dis-ecoli-all-data.RData")
v.data <- data.frame()
for(v in var.n) {
t.data <- data.frame()
p <- as.character(unlist(pi.tags[v,2]))
for(t in 1:length(timestamps)) {
data <- getPiData(path=p, t=timestamps[t], i=15, n=1)
row <- data[round(nrow(data)/2),2]
data <- data.frame(data[round(nrow(data)/2),1])
rownames(data) <- row
t.data <- rbind(t.data, data)
}
if(nrow(v.data) != 0) v.data <- cbind(v.data, t.data)
if(nrow(v.data) == 0) v.data <- t.data
colnames(v.data)[ncol(v.data)] <- as.character(unlist(pi.tags[v,1]))
print(paste(Sys.time(), "finished", colnames(v.data)[ncol(v.data)]))
}
ch.times <- row.names(v.data)
ch.times <- sub("T", " ", ch.times)
ch.times <- sub("Z", " ", ch.times)
all.data <- xts(v.data, order.by = as.POSIXct(ch.times, "%Y-%m-%d %H:%M:%S", tz=""))
all.data <- cbind(all.data, ecoli)
cols2remove <- c("North.Secondary.Influent.COD", "North.Secondary.Influent.NO3", "North.Secondary.Influent.TSS")
rows2remove <- c("North.Secondary.Influent.NH3") # try not removing it in next iterations
cols2remove <- sapply(cols2remove, function(x) which(x == colnames(all.data)))
rows2remove <- sapply(rows2remove, function(x) which(x == colnames(all.data)))
all.data <- all.data[which(!is.na(all.data[,rows2remove])), -cols2remove]
source("GetPiData.R")
rm(list=ls())
library(xts)
library(readxl)
# devtools::install_github("rbechalany/PI-Web-API-Client-R")
library(piwebapi)
###### Setup Pi #####
# Login information
useKerberos <- TRUE
username <- "knewhart"
password <- "Lunabear2@"
validateSSL <- TRUE
debug <- TRUE
piWebApiService <- piwebapi$new("https://pivision/piwebapi", useKerberos, username, password, validateSSL, debug)
# Load tags
pi.tags <- read_excel("C:/Users/KNewhart/Documents/GitHub/MWRD/pi-tags.xls")
pi.tags <- na.omit(pi.tags)
# Fix tags
for(i in 1:nrow(pi.tags)) {
if(is.na(pi.tags[i,2])) next
if(substr(pi.tags[i,2],1,12) == "\\\\APPLEPI_AF") pi.tags[i,2] <- paste0("af:", pi.tags[i,2])
if(substr(pi.tags[i,2],1,9) == "\\\\applepi") pi.tags[i,2] <- paste0("pi:", pi.tags[i,2])
if(substr(pi.tags[i,2],1,9) == "\\\\APPLEPI") pi.tags[i,2] <- paste0("pi:", pi.tags[i,2])
}
# Select variables
var <- c("North Pre-PAA E. coli")
# Set time
start <- paste0("2019-01-01", "T06:00:00Z") # Make sure to convert time to GMT
end <- paste0(as.character(as.Date(Sys.time()) - 1), "T00:00:00Z")
var.n <- sapply(var, function(x) which(x == pi.tags[,1]))
# Fix timestamps - this function creates an xts object from the piWebApiService function above
fix.timestamps <- function(pi.data) {
ch.times <- pi.data[,2]
ch.times <- sub("T", " ", ch.times)
ch.times <- sub("Z", " ", ch.times)
return(cbind(ch.times, pi.data[,1]))
}
# Load daily data
if (exists("all.data")) rm(all.data)
for(i in var.n) {
# assign(make.names(pi.tags[i,1]), piWebApiService$data$getInterpolatedValues(path=unlist(pi.tags[i,2]), startTime = start, endTime = end, interval = "1d")[,1:2])
# assign(make.names(pi.tags[i,1]), fix.timestamps(get(make.names(pi.tags[i,1]))))
# new.objects <- c(new.objects, list(make.names(pi.tags[i,1])))
data.holder <- piWebApiService$data$getRecordedValues(path=as.character(pi.tags[i,2]), startTime = start, endTime = end)[,1:2]
# data.holder <- piWebApiService$data$getInterpolatedValues(path=unlist(pi.tags[i,2]), startTime = start, endTime = end, interval = "1d")[,1:2]
data.holder <- fix.timestamps(data.holder)
data.holder <- xts(as.numeric(data.holder[,2]), order.by = as.POSIXct(data.holder[,1], format = "%Y-%m-%d %H:%M:%S", TZ="GMT"))
colnames(data.holder) <- make.names(pi.tags[i,1])
if (!exists("all.data")) {
all.data <- data.holder
} else {
all.data <- merge(all.data, data.holder)
}
}
ecoli <- all.data
timestamps <- index(all.data)
new.timestamps <- stringr::str_c(stringr::str_sub(as.character(timestamps),1,10), "T")
new.timestamps <- stringr::str_c(new.timestamps, stringr::str_sub(as.character(timestamps),12,19),"Z")
#
# start.and.end <- matrix(nrow=nrow(ecoli)-1,ncol=2)
# library(stringr)
# for(row in 2:nrow(ecoli)){
#   start <- index(ecoli)[row-1]
#   end <- index(ecoli)[row]
#   start.and.end[row-1,1] <- str_c(str_sub(as.character(start),1,10), "T",str_sub(as.character(start),12,19),"Z")
#   start.and.end[row-1,2] <- str_c(str_sub(as.character(end),1,10), "T",str_sub(as.character(end),12,19),"Z")
# }
var <- c(
"North Clarifier 1 Sludge Blanket", # Clarifiers selected from timeseries plots
"North Clarifier 6 Sludge Blanket", # See pre-dis-ecoli-sludge-blanket.png
"North Clarifier 11 Sludge Blanket",
"North Clarifier 12 Sludge Blanket",
"North AB5 RAS TSS",
"North AB4 TSS",
"North AB10 RAS TSS",
"North AB9 RAS TSS",
"North Secondary Aerobic SRT",
"North Secondary Effluent NH3",
"North Secondary Effluent NO3",
"North Secondary Effluent OP",
"North Secondary Effluent TSS",
"North Secondary Effluent NO5",
"North Secondary Influent COD",
"North Secondary Influent Flow",
"North Secondary Influent NH3",
"North Secondary Influent NH3-N",
"North Secondary Influent NO3",
"North Secondary Influent Temperature",
# "North Secondary Influent TKN",
"North Secondary Influent TSS",
"North Secondary Total RAS Flow (MGD)"
# "North Disinfection Flow"
)
var.n <- sapply(var, function(x) which(x == pi.tags[,1]))
#
# # Load daily data
# if (exists("all.data")) rm(all.data)
# for(t in new.timestamps) {
#   data.holder <- piWebApiService$data$getMultipleRecordedValues(paths=c(unlist(pi.tags[var.n,2])), startTime = t)
#   data.holder <- lapply(data.holder, function(x) fix.timestamps(x[1,1:2]))
#   data.holder <- lapply(data.holder, function(x) xts(as.numeric(x[,2]), order.by = as.POSIXct(x[,1], format = "%Y-%m-%d %H:%M:%S", TZ="MST")-6*60*60))
#   data.holder <- do.call(merge, data.holder)
#   colnames(data.holder) <- var
#   if (!exists("all.data")) {
#     all.data <- data.holder
#   } else {
#     all.data <- rbind(all.data, data.holder)
#   }
# }
# save(file = "pre-dis-ecoli-all-data.RData","all.data")
# load("pre-dis-ecoli-all-data.RData")
source("GetPiData.R")
v.data <- data.frame()
for(v in var.n) {
t.data <- data.frame()
p <- as.character(unlist(pi.tags[v,2]))
for(t in 1:length(timestamps)) {
data <- getPiData(path=p, t=timestamps[t], i=15, n=1)
row <- data[round(nrow(data)/2),2]
data <- data.frame(data[round(nrow(data)/2),1])
rownames(data) <- row
t.data <- rbind(t.data, data)
}
if(nrow(v.data) != 0) v.data <- cbind(v.data, t.data)
if(nrow(v.data) == 0) v.data <- t.data
colnames(v.data)[ncol(v.data)] <- as.character(unlist(pi.tags[v,1]))
print(paste(Sys.time(), "finished", colnames(v.data)[ncol(v.data)]))
}
ch.times <- row.names(v.data)
ch.times <- sub("T", " ", ch.times)
ch.times <- sub("Z", " ", ch.times)
all.data <- xts(v.data, order.by = as.POSIXct(ch.times, "%Y-%m-%d %H:%M:%S", tz=""))
all.data <- cbind(all.data, ecoli)
cols2remove <- c("North.Secondary.Influent.COD", "North.Secondary.Influent.NO3", "North.Secondary.Influent.TSS")
rows2remove <- c("North.Secondary.Influent.NH3") # try not removing it in next iterations
cols2remove <- sapply(cols2remove, function(x) which(x == colnames(all.data)))
rows2remove <- sapply(rows2remove, function(x) which(x == colnames(all.data)))
all.data <- all.data[which(!is.na(all.data[,rows2remove])), -cols2remove]
View(all.data)
save("pre-dis-ecoli-2.RData", all.data)
save("all.data", "pre-dis-ecoli-2.RData")
?sve
?save
save("all.data", file="pre-dis-ecoli-2.RData")
