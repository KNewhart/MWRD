```{r include=FALSE}
library(readxl)
library(xts)
library(readr)
library(doSNOW)
library(parallel)
library(neuralnet)

# Fix timestamps - this function creates an xts object from the piWebApiService function above
fix.timestamps <- function(pi.data) {
  ch.times <- pi.data[,2]
  ch.times <- sub("T", " ", ch.times)
  ch.times <- sub("Z", " ", ch.times)
  times <- as.POSIXct(ch.times)
  return(xts::xts(pi.data[,1], order.by = times))
}
```

```{r Import PI data, message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}
# Install and load piwebapi package from Github
# install.packages("devtools")
# library(devtools)
# install_github("rbechalany/PI-Web-API-Client-R")
library(piwebapi)

# Login information
useKerberos <- TRUE
username <- "knewhart"
password <- "Lunabear2@"
validateSSL <- TRUE
debug <- TRUE
piWebApiService <- piwebapi$new("https://pivision/piwebapi", useKerberos, username, password, validateSSL, debug)
```

```{r}
pi.tags <- matrix(c("NPRI 1 BOD Load (t/d)","af:\\\\APPLEPI_AF\\MWRD_Production\\Hite Treatment Plant\\04-Primaries|NPRI 1 BOD Load"), nrow = 1, ncol = 2)
pi.tags <- rbind(pi.tags, 
                 c("NPRI 1 Flow", "\\\\applepi\\FY-P410B"))

start <- paste0("2018-06-01", "T00:00:00Z")
end <- paste0(as.character(as.Date(Sys.time()) - 1), "T00:00:00Z")

for(i in 1:nrow(pi.tags)) {
  assign(make.names(pi.tags[i,1]), piWebApiService$data$getRecordedValues(path=pi.tags[i,2], startTime = start, endTime = end)[,1:2])
assign(make.names(pi.tags[i,1]), fix.timestamps(get(make.names(pi.tags[i,1]))))
}
```


```{r Import Pi tags, include=FALSE}
pi.tags <- read_excel("pi-tags.xls")

# Fix tags
for(i in 1:nrow(pi.tags)) {
  if(is.na(pi.tags[i,2])) next
  if(substr(pi.tags[i,2],1,12) == "\\\\APPLEPI_AF") pi.tags[i,2] <- paste0("af:", pi.tags[i,2])
  if(substr(pi.tags[i,2],1,9) == "\\\\applepi") pi.tags[i,2] <- paste0("pi:", pi.tags[i,2])
}

# Load data
new.objects <- list()
for(i in 1:nrow(pi.tags)) {
  if(is.na(pi.tags[i,2])) next
  assign(make.names(pi.tags[i,1]), piWebApiService$data$getRecordedValues(path=unlist(pi.tags[i,2]), startTime = start, endTime = end)[,1:2])
  assign(make.names(pi.tags[i,1]), fix.timestamps(get(make.names(pi.tags[i,1]))))
  new.objects <- c(new.objects, list(make.names(pi.tags[i,1])))
}
```











```{r eval=FALSE, include=FALSE}
# NOT RUNNING
pi.tags <- c("A Basin 9 NH3  Zone C A Pass", "\\\\applepi\\AI_N96B",
             "A Basin 9 NH3 C Pass", "\\\\applepi\\AI_N99B",
             "A Basin 9 NO3 C Pass", "\\\\applepi\\AI_N99A",
             "A Basin 9 NO3 Zone A A Pass", "\\\\applepi\\AI_N93A",
             "A Basin 9 NO3 Zone C A Pass", "\\\\applepi\\AI_N96A",
             "A Basin 9 NSEC Temp", "\\\\applepi\\TI_N90",
             "AB Influent Gate 9", "\\\\applepi\\FC_N90",
             "AE Basin 9A Air", "\\\\applepi\\FC_N94A")
```

