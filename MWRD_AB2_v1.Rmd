```{r include=FALSE}
library(readxl)
library(xts)
library(readr)
library(doSNOW)
library(parallel)
library(neuralnet)
library(factoextra)

# Fix timestamps - this function creates an xts object from the piWebApiService function above
fix.timestamps <- function(pi.data) {
  ch.times <- pi.data[,2]
  ch.times <- sub("T", " ", ch.times)
  ch.times <- sub("Z", " ", ch.times)
  times <- as.POSIXct(ch.times)
  return(xts::xts(pi.data[,1], order.by = times))
}

# Install and load piwebapi package from Github
# install.packages("devtools")
# library(devtools)
# install_github("rbechalany/PI-Web-API-Client-R")
library(piwebapi)

# Login information
useKerberos <- TRUE
username <- "knewhart"
password <- "Lunabear2@"
validateSSL <- TRUE
debug <- TRUE
piWebApiService <- piwebapi$new("https://pivision/piwebapi", useKerberos, username, password, validateSSL, debug)
```



```{r Import Pi tags, include=FALSE}
pi.tags <- read_excel("pi-tags.xls")

# Fix tags
for(i in 1:nrow(pi.tags)) {
  if(is.na(pi.tags[i,2])) next
  if(substr(pi.tags[i,2],1,12) == "\\\\APPLEPI_AF") pi.tags[i,2] <- paste0("af:", pi.tags[i,2])
  if(substr(pi.tags[i,2],1,9) == "\\\\applepi") pi.tags[i,2] <- paste0("pi:", pi.tags[i,2])
}
pi.tags <- na.omit(pi.tags)

pi.tags.2.remove <- c("South Primary Influent Flow", "South Secondary Influent Flow")
pi.tags.2.remove <- sapply(pi.tags.2.remove, function(x) which(x == pi.tags[,1]))
pi.tags <- pi.tags[-pi.tags.2.remove,]

start <- paste0("2019-01-04", "T00:00:00Z")
end <- paste0("2019-02-04", "T00:00:00Z")
# end <- paste0(as.character(as.Date(Sys.time()) - 1), "T00:00:00Z")

# Load data
new.objects <- list()
for(i in 1:nrow(pi.tags)) {
  # assign(make.names(pi.tags[i,1]), piWebApiService$data$getInterpolatedValues(path=unlist(pi.tags[i,2]), startTime = start, endTime = end, interval = "1d")[,1:2])
  # assign(make.names(pi.tags[i,1]), fix.timestamps(get(make.names(pi.tags[i,1]))))
  # new.objects <- c(new.objects, list(make.names(pi.tags[i,1])))
  
  data.holder <- piWebApiService$data$getInterpolatedValues(path=unlist(pi.tags[i,2]), startTime = start, endTime = end, interval = "1d")[,1:2]
  data.holder <- fix.timestamps(data.holder)
  colnames(data.holder) <- make.names(pi.tags[i,1])
  if (i ==1 ) {
    all.data <- data.holder
  } else {
    all.data <- merge(all.data, data.holder)
  }
}

cols2keep <- which(!is.na(all.data[1,]))
all.data <- all.data[,cols2keep]
```




```{r Distributions}
tiff(filename="MWRD_AB2_v1_density.tiff", units = "in", width = 20, height = 20, res = 200)
par(mfrow=c(round(sqrt(ncol(all.data))), round(ncol(all.data)/round(sqrt(ncol(all.data))))),
    mar=c(3,3,3,1)+.01)
for(i in 1:ncol(all.data)) {
  plot(density(as.vector(na.omit(all.data[,i]))), 
       main = colnames(all.data)[i],
       xlab="", ylab="")
}
dev.off()

tiff(filename="MWRD_AB2_v1_probability.tiff", units = "in", width = 20, height = 20, res = 200)
par(mfrow=c(round(sqrt(ncol(all.data))), round(ncol(all.data)/round(sqrt(ncol(all.data))))),
    mar=c(3,3,3,1)+.01)
for(i in 1:ncol(all.data)) {
  qqnorm(as.vector(na.omit(all.data[,i])), main = colnames(all.data)[i])
  qqline(as.vector(na.omit(all.data[,i])))
}
dev.off()
```




```{r PCA}
pca.data <- scale(as.data.frame(na.omit(all.data)))
pca.results <- princomp(pca.data) # Spectral decomposition
tiff(filename="MWRD_AB2_v1_PCA.tiff", units = "in", width = 11, height = 6.5, res = 200)
fviz_pca_var(pca.results, labelsize = 3,
             col.var = "contrib",
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
             repel = TRUE,
             ggtheme=theme(axis.text=element_text(size=8), 
                           axis.title=element_text(size=8),
                           plot.title=element_text(size=8),
                           legend.title=element_text(size=8),
                           legend.text=element_text(size=8)
             ))
dev.off()

AB2 <- grep("AB2", colnames(all.data))
pca.data <- scale(as.data.frame(na.omit(all.data[,AB2])))
pca.results <- princomp(pca.data) # Spectral decomposition
tiff(filename="MWRD_AB2_v1_PCA_AB2.tiff", units = "in", width = 11, height = 6.5, res = 200)
fviz_pca_var(pca.results, labelsize = 3,
             col.var = "contrib",
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
             repel = TRUE,
             ggtheme=theme(axis.text=element_text(size=8), 
                           axis.title=element_text(size=8),
                           plot.title=element_text(size=8),
                           legend.title=element_text(size=8),
                           legend.text=element_text(size=8)
             ))
dev.off()

AB5 <- grep("AB5", colnames(all.data))
pca.data <- scale(as.data.frame(na.omit(all.data[,AB5])))
pca.results <- princomp(pca.data) # Spectral decomposition
tiff(filename="MWRD_AB2_v1_PCA_AB5.tiff", units = "in", width = 11, height = 6.5, res = 200)
fviz_pca_var(pca.results, labelsize = 3,
             col.var = "contrib",
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
             repel = TRUE,
             ggtheme=theme(axis.text=element_text(size=8), 
                           axis.title=element_text(size=8),
                           plot.title=element_text(size=8),
                           legend.title=element_text(size=8),
                           legend.text=element_text(size=8)
             ))
dev.off()

AB9 <- grep("AB9", colnames(all.data))
pca.data <- scale(as.data.frame(na.omit(all.data[,AB9])))
pca.results <- princomp(pca.data) # Spectral decomposition
tiff(filename="MWRD_AB2_v1_PCA_AB9.tiff", units = "in", width = 11, height = 6.5, res = 200)
fviz_pca_var(pca.results, labelsize = 3,
             col.var = "contrib",
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
             repel = TRUE,
             ggtheme=theme(axis.text=element_text(size=8), 
                           axis.title=element_text(size=8),
                           plot.title=element_text(size=8),
                           legend.title=element_text(size=8),
                           legend.text=element_text(size=8)
             ))
dev.off()

AB10 <- grep("AB10", colnames(all.data))
pca.data <- scale(as.data.frame(na.omit(all.data[,AB10])))
pca.results <- princomp(pca.data) # Spectral decomposition
tiff(filename="MWRD_AB2_v1_PCA_AB10.tiff", units = "in", width = 11, height = 6.5, res = 200)
fviz_pca_var(pca.results, labelsize = 3,
             col.var = "contrib",
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
             repel = TRUE,
             ggtheme=theme(axis.text=element_text(size=8), 
                           axis.title=element_text(size=8),
                           plot.title=element_text(size=8),
                           legend.title=element_text(size=8),
                           legend.text=element_text(size=8)
             ))
dev.off()

```







```{r eval=FALSE, include=FALSE}
# NOT RUNNING
pi.tags <- c("A Basin 9 NH3  Zone C A Pass", "\\\\applepi\\AI_N96B",
             "A Basin 9 NH3 C Pass", "\\\\applepi\\AI_N99B",
             "A Basin 9 NO3 C Pass", "\\\\applepi\\AI_N99A",
             "A Basin 9 NO3 Zone A A Pass", "\\\\applepi\\AI_N93A",
             "A Basin 9 NO3 Zone C A Pass", "\\\\applepi\\AI_N96A",
             "A Basin 9 NSEC Temp", "\\\\applepi\\TI_N90",
             "AB Influent Gate 9", "\\\\applepi\\FC_N90",
             "AE Basin 9A Air", "\\\\applepi\\FC_N94A")
```

